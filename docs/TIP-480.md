## TIP (Tcl Improvement Proposal)

### WORK IN PROGRESS

This TIP proposes an enhancement of the proc command to make the handling of the aforementioned options efficient and trivial.  This allows Tcl Programmers to provide a more uniform syntax across their apps without constantly writing slow and error-prone option parsing for each proc.  

This is meant to be a simpler alternative to other proposals such as [TIP-457](http://core.tcl.tk/tips/doc/trunk/tip/457.md) (Named Arguments) which attempt to provide a framework of options and features to arguments.  


## Abstract

This TIP proposes an enhancement of the Tcl language to support option parsing of proc, method, and lambdas (apply).  

## Rationale

Tcl's Built-In commands almost always expect options (- prefixed keys, sometimes followed by a value) followed by the commands arguments.  It is currently fairly difficult (and slow) to mimic this on the Tcl-side as it requires looping through args in most cases.  

We end up with a situation where passing arguments takes on many different forms which do not generally match the built-in commands argument handling.

There are currently two other TIP's providing proposals to how argument handling could be improved ([TIP-457](http://core.tcl.tk/tips/doc/trunk/tip/479.md)) ([TIP-479](http://core.tcl.tk/tips/doc/trunk/tip/479.md)), of these, this proposals goal is to provide a simpler syntax & approach - allowing the command to implement the trivial pieces (upvar, required, defaults).  

## Specification

This TIP calls for an eventual modification to the `proc`, `method`, and `apply` APIs, starting as a separate command (oproc), providing the enhanced option handling mechanics.  For the remainder of this specification, the former (proc) will be assumed.  

Throughout this specification, there are three basic principles of options which will always be followed:

  1. Options may be provided in any order, so-long as they come before the command arguments.
  2. To the parser, options are always optional. It is up to the command to handle options which were expected but not provided or invalid.
  3. Options may or may not require a value provided.  Therefore, options will be either one (-opt) or two (-opt value) elements.  It is an error to provide options which do not conform to their defined format.

> Below is a rough outline of the specifics of the specification as this is a WORK IN PROGRESS - feedback welcome :)

- Options handling can be confirmed when all of the following are true:
  1. The first argument begins with a dash followed by the option key (-opt).
  2. Each option key begins with a dash (-), optionally followed by a single value (value name) indicating a value is expected when the option is given.
  3. Option definitions are terminated by a double-dash (--) at which point standard arguments may be defined `{-opt1 -opt2 val -- foo bar args}`.

## Declaration Syntax Examples

In order to provide a clear example of how the proposed syntax allows building commands which handle options and arguments similar to Tcl's built-in commands, below are examples of how we would declare procs with the same options as their native counterparts.

> Note that the double-dash (--) value is always optional when invoking any command, but required when defining a command with option parsing.

### [unset](https://www.tcl.tk/man/tcl8.6/TclCmd/unset.htm)

> unset ?-nocomplain? ?--? ?name name name ...?

```tcl
proc unset {-nocomplain -- args} { # Handle # }
```

### [subst](https://www.tcl.tk/man/tcl8.6/TclCmd/subst.htm)

> subst ?-nobackslashes? ?-nocommands? ?-novariables? string

```tcl
proc subst {-nobackslashes -nocommands -novariables -- string} { # Handle # }
```

### [source](https://www.tcl.tk/man/tcl8.6/TclCmd/source.htm)

> source ?-encoding encodingName? fileName

```tcl
proc source {-encoding encodingName -- filename} { # Handle # }
```

### [switch](https://www.tcl.tk/man/tcl8.6/TclCmd/switch.htm)

> switch ?options? string pattern body ?pattern body ...?
>
> switch ?options? string {pattern body ?pattern body ...?}

```tcl
proc switch {
  -exact
  -glob
  -regexp
  -nocase
  -matchvar varName
  -indexvar varName
  -- string pattern args
} { # Handle # }
```

---

While such a syntax does have a few considerations, it provides a clean syntax for defining the available options which is easily readable, parseable, and enforceable.  Additionally, it allows for automatically generated error messages which can hint at the available option or value.

### Implementation

 - A pure-tcl initial implementation may be found as [oproc-1.0.0.tm](https://github.com/Dash-OS/tcl-modules/blob/master/oproc-1.0.0.tm)

### Proposed Changes & Ideas

 - Allow boolean/toggle options to provide a true/false value.  (-opt or -opt 1 or -opt 0).
 - Modify the general specification so that it can be extended in the future to take options (allowing it to provide the features of other proposals such as  [TIP-457](http://core.tcl.tk/tips/doc/trunk/tip/479.md)).
   - Likely as simple as allowing the second value to be a list in a similar fashion to how 457's proposal currently defines.
 - ~~Allow opts to be placed after the command arguments (this would mean args could not be used and is likely not a good solution~~ `simply using $args should be sufficient in this case.`
 - Instead of a variable (`$opts`), options become local variables within the command body.
 - Provide a way for options which may be boolean (-opt) OR value-based (-opt value).
   - One method for declaring this was proposed as `{-opt1 ?valName -opt2 valName -- args}` where `-opt1` could be provided as `procname -opt1` or `procname -opt1 $value`
